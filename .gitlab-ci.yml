stages:
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "18"

# Cache des dépendances npm
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - backend/node_modules/
    - frontend/node_modules/

# ===================
# TESTS
# ===================

# Tests Backend avec Jest
test-backend:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - cd backend
    - npm ci
    - npm run test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    paths:
      - backend/coverage/
  rules:
    - changes:
        - backend/**/*

# Tests Frontend avec Cypress
test-frontend:
  stage: test
  image: cypress/browsers:node18.12.0-chrome107
  script:
    # Démarrer le backend en arrière-plan
    - cd backend && npm ci && npm run updatedb && npm run startdev &
    - cd frontend && npm ci
    # Attendre que le backend soit prêt
    - npx wait-on http://localhost:3000/health --timeout 60000
    # Lancer les tests Cypress
    - npm run cypress:run
  artifacts:
    when: always
    paths:
      - frontend/cypress/videos/
      - frontend/cypress/screenshots/
    expire_in: 1 week
  rules:
    - changes:
        - frontend/**/*
        - backend/**/*

# Lint Backend
lint-backend:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - cd backend
    - npm ci
    - npm run lint || true
  allow_failure: true
  rules:
    - changes:
        - backend/**/*

# Lint Frontend
lint-frontend:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - cd frontend
    - npm ci
    - npm run lint || true
  allow_failure: true
  rules:
    - changes:
        - frontend/**/*

# ===================
# BUILD
# ===================

# Build du frontend pour production
build-frontend:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - cd frontend
    - npm ci
    - npm run build
    # Copier les fichiers vers le backend
    - cp -r dist/* ../backend/src/frontend/
  artifacts:
    paths:
      - backend/src/frontend/
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ===================
# DEPLOY
# ===================

# Déploiement sur Scalingo
# URL d'exposition de l'API : https://$SCALINGO_APP_NAME.osc-fr1.scalingo.io/
scalingo:
  stage: deploy
  tags:
    - docker
  variables:
    SCALINGO_API_TOKEN: $scalingo
    SCALINGO_APP_NAME: $app
    SCALINGO_REGION: osc-fr1
    GIT_DEPTH: 0
    PROJECT_DIR: backend
  image: ruby:3.1.3
  script:
    # Installer Scalingo CLI
    - curl -O https://cli-dl.scalingo.com/install && bash install
    # Configurer le projet
    - scalingo --app=$SCALINGO_APP_NAME env-set PROJECT_DIR=$PROJECT_DIR
    # Connexion à Scalingo
    - scalingo login --api-token $SCALINGO_API_TOKEN
    # Créer une clé SSH temporaire
    - mkdir -p ~/.dpl
    - ssh-keygen -t rsa -N "" -C $HOSTNAME -f ~/.dpl/id_rsa
    - scalingo keys-remove dpl_tmp_key || echo "Suppression clé existante"
    - scalingo keys-add dpl_tmp_key ~/.dpl/id_rsa.pub
    # Configurer le dépôt distant
    - scalingo --app=$SCALINGO_APP_NAME git-setup --remote scalingo-dpl --force
    # Build du frontend et intégration au backend
    - curl https://raw.githubusercontent.com/creationix/nvm/master/install.sh | bash
    - export NVM_DIR="$HOME/.nvm"
    - \. "$NVM_DIR/nvm.sh"
    - nvm install node && nvm use node
    - cd frontend && npm ci && npm run build && cp -rf dist/* ../backend/src/frontend/
    # Commit et push vers Scalingo
    - git config --global user.email "$GITLAB_USER_EMAIL"
    - git config --global user.name "$GITLAB_USER_NAME"
    - cd ../backend/src/frontend && git add . && git commit -m "MAJ frontend" || true
    - cd ../../..
    # Pousser vers Scalingo (déclenche le déploiement)
    - "GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=no -i ~/.dpl/id_rsa' git push scalingo-dpl HEAD:refs/heads/main -f"
    # Nettoyer
    - scalingo keys-remove dpl_tmp_key || echo "Suppression clé temporaire"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  when: manual
  environment:
    name: production
    url: https://$SCALINGO_APP_NAME.osc-fr1.scalingo.io

# Déploiement des pages GitLab (frontend statique)
pages:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - mkdir -p public
    - cd frontend
    - npm ci
    - npm run build
    - cp -r dist/* ../public/
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ===================
# VARIABLES REQUISES
# ===================
# Les variables suivantes doivent être définies dans Settings > CI/CD > Variables :
#
# SCALINGO_API_TOKEN : Token d'API Scalingo (masqué)
#   - Généré via User Settings > API tokens sur Scalingo
#
# SCALINGO_APP_NAME : Nom de l'application sur Scalingo
